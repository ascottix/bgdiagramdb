<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BgDiagramDb Analysis</title>
    <meta name="description" content="Backgammon position analysis based on GnuBG Core (GNU Backgammon).">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        #board-container {
            aspect-ratio: 5 / 4;
        }

        .bgdiagram__background {
            fill: white !important;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <h1 class="display-6">BgDiagramDb Analysis</h1>
        <div class="mb-3 row g-2">
            <div class="col-md-9">
                <label for="xgidInput" class="form-label">XGID</label>
                <input type="text" class="form-control" id="xgidInput" placeholder="Insert a XGID position here">
            </div>
            <div class="col-md-3">
                <label for="pliesSelect" class="form-label">Depth (plies)</label>
                <select class="form-select" id="pliesSelect">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div id="board-container" class="bgdiagram">
                    <!-- Here goes the diagram -->
                </div>
            </div>
            <div class="col-md-6 d-flex flex-column">
                <div id="output-panel" class="flex-grow-1 mb-2 markdown border rounded p-3">
                    <!-- Here goes the analysis -->
                </div>
                <button class="btn btn-outline-secondary" id="copyBtn">Copy analysis</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Note: you need to serve this page (e.g. with "npx serve ."), it doesn't work with file://
        import { BgDiagram } from 'https://cdn.jsdelivr.net/gh/ascottix/bgdiagram@latest/dist/bgdiagram.min.js';
        import { initGnubgCore } from 'https://cdn.jsdelivr.net/gh/ascottix/gnubg-core@v1.0.9/dist/gnubg-core.js';

        const diagramOptions = {}

        let currentMarkdown = '';

        // Initialize the module
        const gnuBgCore = await initGnubgCore();

        const xgidInput = document.getElementById('xgidInput');
        const outputPanel = document.getElementById('output-panel');
        const copyBtn = document.getElementById('copyBtn');

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function renderCubeAction(markdown, res) {
            const data = res.data;
            const optimal = data.equity[3];
            const actions = ['No double', 'Double, take', 'Double, pass'];
            const best = optimal == data.equity[0] ? 0 : optimal == data.equity[1] ? 1 : 2;

            const equity = (eq) => {
                const delta = eq - optimal;
                eq = '**' + eq.toFixed(3) + '**';
                return delta == 0 ? eq : delta < 0 ? `${eq} (${delta.toFixed(3)})` : `${eq} (+${delta.toFixed(3)})`;
            }

            markdown.push('# ' + capitalize(res.action));
            markdown.push('---');
            markdown.push('| Action | Equity |');
            markdown.push('| --- | --- |');
            actions.forEach((action, index) => {
                markdown.push(`| ${action} | ${equity(data.equity[index])} |`);
            });
            markdown.push();
            markdown.push('Best cube action: ' + actions[best].toLocaleLowerCase() +
                (best == 0 ? (data.equity[1] < data.equity[2] ? ', take' : ', pass') : ''));
        }

        function renderPlayAction(markdown, res) {
            const moves = res.data;

            markdown.push('# ' + moves[0].move);
            markdown.push('---');
            markdown.push('<table class="bgdb__analysis--movelist">');
            moves.slice(0, 10).forEach((move, index) => {
                const p = (i) => {
                    const e = i == 5 ? 1 - move.eval[0] : move.eval[i];
                    return (e * 100).toFixed(1);
                }

                const equity = move.equity[0] - (index == 0 ? 0 : moves[0].equity[0]);
                const color = equity <= -0.08 ? ' text-danger' : equity <= -0.02 ? ' text-success' : '';

                markdown.push('<tr>');
                markdown.push(`<td><span class="fs-3 pe-3">${move.move}</span></td>`);
                markdown.push(`<td><span class="fs-3${color}">${equity.toFixed(3)}</span></td>`);
                markdown.push('</tr>');
                markdown.push('<tr>');
                markdown.push(`<td><span class="smalltext pe-2">P: ${p(0)} ${p(1)} ${p(2)} &nbsp; O: ${p(5)} ${p(3)} ${p(4)}</span></td>`);
                markdown.push('<td></td>');
                markdown.push('</tr>');
            });
            markdown.push('</table>');
        }

        function updateAnalysis() {
            const xgid = xgidInput.value;

            // Update the diagram
            const svg = BgDiagram.fromXgid(xgid, diagramOptions);
            document.getElementById('board-container').innerHTML = svg;

            // Call GnuBG Core to get the analysis
            const evalDepth = parseInt(pliesSelect.value);
            const startTime = Date.now();
            const res = gnuBgCore.hint(xgid, evalDepth);
            const elapsedTime = Date.now() - startTime;
            console.log('Done in', elapsedTime, 'ms');
            console.log(res);

            const markdown = [];

            if (res.action == 'play') {
                renderPlayAction(markdown, res);
            } else {
                renderCubeAction(markdown, res);
            }

            currentMarkdown = markdown.join('\n');

            outputPanel.innerHTML = marked.parse(currentMarkdown);
        }

        // XGID changed
        xgidInput.addEventListener('change', updateAnalysis);

        xgidInput.addEventListener('paste', () => setTimeout(updateAnalysis, 0));

        xgidInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                updateAnalysis();
            }
        });

        // Depth changed
        pliesSelect.addEventListener('change', updateAnalysis);

        // Copy button
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentMarkdown).then(() => {
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy analysis', 1500);
            });
        });

        // Initialization
        const params = new URLSearchParams(window.location.search);

        const bsTheme = params.get('appTheme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        console.log(bsTheme);
        document.documentElement.setAttribute('data-bs-theme', bsTheme);

        const bgdTheme = params.get('bgdTheme');
        if (bgdTheme) {
            document.getElementById('board-container').classList.add('bgdiagram__theme--' + bgdTheme);
        }

        if(params.get('bgdHL')) {
            diagramOptions.homeOnLeft = true;
        }

        const depth = params.get('d');
        if (depth) {
            pliesSelect.value = depth;
        }

        const xgid = params.get('xgid');
        if (xgid) {
            xgidInput.value = xgid;
            updateAnalysis();
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ascottix/bgdiagram@latest/dist/bgdiagram.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/ascottix/bgdiagram@latest/dist/bgdiagram_themes_base.min.css" media="print"
        onload="this.media='all'; this.onload=null;">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/ascottix/bgdiagram@latest/dist/bgdiagram_themes_pastels.min.css" media="print"
        onload="this.media='all'; this.onload=null;">
</body>

</html>